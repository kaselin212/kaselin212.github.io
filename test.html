<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§æœƒè­°å®¤å€™è£œæ©Ÿåˆ¶ Demo</title>
    <style>
        :root {
            --primary: #2563eb;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gray: #6b7280;
            --bg: #f3f4f6;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 20px; color: #333; max-width: 1000px; margin: 0 auto; }
        h2, h3 { color: #1f2937; }
        
        /* Layout */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        /* Form Elements */
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; }
        select, button { padding: 10px; border-radius: 6px; border: 1px solid #d1d5db; width: 100%; margin-bottom: 15px; }
        button { cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; border: none; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-danger { background: var(--danger); color: white; border: none; }
        .btn-confirm { background: var(--success); color: white; border: none; }
        
        /* Status Display */
        .status-box { padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb; margin-top: 10px; }
        .date-display { font-size: 1.2em; color: var(--primary); font-weight: bold; margin-bottom: 10px; display: block; }
        
        .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; color: white; }
        .bg-green { background: var(--success); }
        .bg-red { background: var(--danger); }
        .bg-orange { background: var(--warning); }
        .bg-gray { background: var(--gray); }

        /* Queue List */
        .queue-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee; }
        .queue-item:last-child { border-bottom: none; }
        
        /* Simulation Controls */
        .sim-control { border-top: 2px dashed #ccc; padding-top: 15px; margin-top: 15px; }
        
        /* Notification Modal Simulation */
        .notification-area { background: #fffbeb; border: 1px solid #fcd34d; padding: 15px; border-radius: 8px; display: none; animation: slideIn 0.3s ease; }
        .timer-bar { height: 4px; background: #e5e7eb; border-radius: 2px; margin: 10px 0; overflow: hidden; }
        .timer-fill { height: 100%; background: var(--warning); width: 100%; transition: width 1s linear; }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

    <h1>ğŸ“… æœƒè­°å®¤é ç´„èˆ‡å€™è£œæ©Ÿåˆ¶ç¤ºç¯„</h1>
    <p>æ¨¡æ“¬æƒ…å¢ƒï¼šä½¿ç”¨è€…è¨­å®šã€Œæ¯æœˆæœ€å¾Œä¸€é€±ã€çš„ç‰¹æ®Šé€±æœŸï¼Œä¸¦è§¸ç™¼å€™è£œæµç¨‹ã€‚</p>

    <div class="grid">
        <div class="card">
            <h3>1. è¨­å®šé€±æœŸè¦å‰‡ (User Action)</h3>
            <label>é¸æ“‡é€±æœŸæ¨¡å¼</label>
            <select id="patternSelect" onchange="calculateDate()">
                <option value="last_wed">æ¯æœˆæœ€å¾Œä¸€é€±çš„æ˜ŸæœŸä¸‰ (Demoé‡é»)</option>
                <option value="3rd_fri">æ¯æœˆç¬¬ 3 é€±çš„æ˜ŸæœŸäº”</option>
                <option value="last_day">æ¯æœˆçš„æœ€å¾Œä¸€å¤©</option>
            </select>

            <label>ç³»çµ±è‡ªå‹•è©¦ç®—æ—¥æœŸ (2025å¹´12æœˆç‚ºä¾‹)</label>
            <span id="calculatedDate" class="date-display">è¨ˆç®—ä¸­...</span>

            <label>è¼¸å…¥é ç´„äººå§“å</label>
            <input type="text" id="userName" placeholder="ä¾‹å¦‚ï¼šAlice" style="padding:10px; width:95%; margin-bottom:15px; border:1px solid #ccc; border-radius:6px;">

            <button class="btn-primary" onclick="attemptBooking()">ğŸ“… å˜—è©¦é ç´„</button>
            <p style="font-size:0.9em; color:#666;">*è‹¥æ™‚æ®µå·²æ»¿ï¼Œå°‡è‡ªå‹•é€²å…¥å€™è£œæ¸…å–®</p>
        </div>

        <div class="card">
            <h3>2. ç³»çµ±ç‹€æ…‹èˆ‡è³‡æ–™åº« (System View)</h3>
            
            <div class="status-box">
                <div><strong>ç•¶å‰æ™‚æ®µç‹€æ…‹ï¼š</strong> <span id="slotStatus" class="badge bg-green">å¯é ç´„</span></div>
                <div style="margin-top:5px;"><strong>ç›®å‰é ç´„è€…ï¼š</strong> <span id="currentOwner">ç„¡</span></div>
            </div>

            <h4 style="margin-top:20px;">å€™è£œéšŠåˆ— (Waitlist Queue)</h4>
            <div id="waitlistQueue" style="background:#f9fafb; padding:10px; border-radius:6px; min-height:50px;">
                <p style="color:#999; text-align:center; margin:0;">ç›®å‰ç„¡äººå€™è£œ</p>
            </div>
            
            <div style="margin-top:10px; font-size:0.8em; color:gray;">
                <p>âš™ï¸ è¦å‰‡ï¼šFIFO (å…ˆé€²å…ˆå‡º)</p>
                <p>ğŸ”’ é–å®šæ©Ÿåˆ¶ï¼šé€šçŸ¥å¾Œé–å®š 24 å°æ™‚</p>
            </div>
        </div>
    </div>

    <div class="card sim-control">
        <h3>3. æµç¨‹æ¨¡æ“¬æ§åˆ¶å° (Simulation)</h3>
        <p>åœ¨æ­¤æ¨¡æ“¬ã€ŒåŸé ç´„è€…å–æ¶ˆã€ï¼Œè§€å¯Ÿç³»çµ±å¦‚ä½•è‡ªå‹•è§¸ç™¼é€šçŸ¥ã€‚</p>
        
        <button class="btn-danger" id="cancelBtn" onclick="cancelCurrentBooking()" disabled>âŒ æ¨¡æ“¬ï¼šåŸé ç´„è€…å–æ¶ˆæœƒè­°</button>

        <div id="notificationArea" class="notification-area">
            <h4>ğŸ”” ç³»çµ±é€šçŸ¥ (çµ¦å€™è£œé †ä½ #1)</h4>
            <p><strong><span id="notifyUser">User</span></strong> æ‚¨å¥½ï¼Œ12æœˆæœ€å¾Œä¸€é€±é€±ä¸‰çš„æœƒè­°å®¤å·²é‡‹å‡ºï¼</p>
            <p>ç³»çµ±å·²ç‚ºæ‚¨<strong>é–å®šæ™‚æ®µ</strong>ï¼Œè«‹åœ¨æœŸé™å…§ç¢ºèªã€‚</p>
            
            <div class="timer-bar"><div class="timer-fill" id="timerFill"></div></div>
            <p style="font-size:0.8em; text-align:right;">å‰©é¤˜ç¢ºèªæ™‚é–“ï¼š<span id="timeLeft">24:00:00</span></p>

            <div style="display:flex; gap:10px;">
                <button class="btn-confirm" onclick="confirmWaitlist()">âœ” ç¢ºèªé ç´„</button>
                <button class="btn-danger" onclick="rejectWaitlist()">âœ– æ”¾æ£„ (è®“çµ¦ä¸‹ä¸€ä½)</button>
            </div>
        </div>
        
        <div id="logs" style="margin-top:20px; font-family:monospace; font-size:0.85em; background:#333; color:#0f0; padding:10px; border-radius:6px; max-height:150px; overflow-y:auto;">
            <div>> System Ready...</div>
        </div>
    </div>

    <script>
        // æ¨¡æ“¬å¾Œç«¯è³‡æ–™
        let currentBooking = null; // { user: "Name", status: "confirmed" }
        let waitlist = []; // [ "Bob", "Charlie" ]
        let pendingUser = null; // ç•¶å‰æ­£åœ¨è¢«é€šçŸ¥çš„å€™è£œè€…
        let timerInterval = null;

        // åˆå§‹åŒ–æ—¥æœŸè¨ˆç®—
        window.onload = function() {
            calculateDate();
            addLog("ç³»çµ±åˆå§‹åŒ–å®Œæˆã€‚");
        }

        // 1. é€±æœŸè¨ˆç®—é‚è¼¯ (æ ¸å¿ƒåŠŸèƒ½ä¸€)
        function calculateDate() {
            const pattern = document.getElementById('patternSelect').value;
            const year = 2025;
            const month = 11; // 12æœˆ (JSå¾0é–‹å§‹)
            let dateObj;

            if (pattern === 'last_wed') {
                // æ‰¾å‡ºç•¶æœˆæœ€å¾Œä¸€å¤©
                dateObj = new Date(year, month + 1, 0); 
                // å¾€å›æ‰¾ç›´åˆ°æ˜ŸæœŸä¸‰ (Wednesday is 3)
                while (dateObj.getDay() !== 3) {
                    dateObj.setDate(dateObj.getDate() - 1);
                }
            } else if (pattern === '3rd_fri') {
                dateObj = new Date(year, month, 1);
                let count = 0;
                while (count < 3) {
                    if (dateObj.getDay() === 5) count++;
                    if (count < 3) dateObj.setDate(dateObj.getDate() + 1);
                }
            } else {
                dateObj = new Date(year, month + 1, 0); // æœ€å¾Œä¸€å¤©
            }

            const dateStr = `${dateObj.getFullYear()}/${dateObj.getMonth()+1}/${dateObj.getDate()} (é€±${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][dateObj.getDay()]})`;
            document.getElementById('calculatedDate').innerText = dateStr;
        }

        // 2. é ç´„ / å€™è£œé‚è¼¯ (æ ¸å¿ƒåŠŸèƒ½äºŒ)
        function attemptBooking() {
            const user = document.getElementById('userName').value || "Anonymous";
            
            if (!currentBooking && !pendingUser) {
                // æƒ…å¢ƒ A: ç›´æ¥é ç´„æˆåŠŸ
                currentBooking = { user: user, status: 'confirmed' };
                updateUI();
                addLog(`[æˆåŠŸ] ${user} å·²é ç´„æˆåŠŸã€‚`);
            } else {
                // æƒ…å¢ƒ B: é€²å…¥å€™è£œ
                // æª¢æŸ¥æ˜¯å¦å·²åœ¨åå–®ä¸­ (ç°¡å–®é˜²å‘†)
                if (currentBooking?.user === user || waitlist.includes(user)) {
                    alert("æ‚¨å·²ç¶“åœ¨é ç´„æˆ–å€™è£œåå–®ä¸­ï¼");
                    return;
                }
                waitlist.push(user);
                updateUI();
                addLog(`[å€™è£œ] æ™‚æ®µå·²æ»¿ï¼Œ${user} åŠ å…¥å€™è£œéšŠåˆ— (é †ä½ ${waitlist.length})ã€‚`);
            }
            
            // æ¸…ç©ºè¼¸å…¥æ¡†æ–¹ä¾¿ä¸‹ä¸€ä½æ¸¬è©¦
            const names = ["Bob", "Charlie", "David", "Eve"];
            document.getElementById('userName').value = names[Math.floor(Math.random() * names.length)];
        }

        // 3. å–æ¶ˆèˆ‡è§¸ç™¼é€šçŸ¥é‚è¼¯ (æ ¸å¿ƒåŠŸèƒ½ä¸‰ã€å››)
        function cancelCurrentBooking() {
            if (!currentBooking) return;
            const oldUser = currentBooking.user;
            currentBooking = null;
            addLog(`[å–æ¶ˆ] åŸé ç´„è€… ${oldUser} å·²å–æ¶ˆã€‚`);
            
            checkWaitlist(); // æª¢æŸ¥å€™è£œ
            updateUI();
        }

        function checkWaitlist() {
            if (waitlist.length > 0) {
                // å–å‡ºç¬¬ä¸€ä½
                pendingUser = waitlist.shift();
                addLog(`[é€šçŸ¥] ç³»çµ±é–å®šæ™‚æ®µï¼Œé€šçŸ¥å€™è£œ #1: ${pendingUser}ã€‚`);
                
                // é–å®š UI ç‹€æ…‹
                document.getElementById('slotStatus').innerText = "ç³»çµ±é–å®šä¸­ (ç­‰å¾…å›è¦†)";
                document.getElementById('slotStatus').className = "badge bg-orange";
                
                showNotification(pendingUser);
            } else {
                addLog(`[é‡‹å‡º] ç„¡å€™è£œäººå“¡ï¼Œæ™‚æ®µé‡‹å‡ºç‚ºå¯é ç´„ç‹€æ…‹ã€‚`);
            }
        }

        // æ¨¡æ“¬é€šçŸ¥å½ˆçª—èˆ‡å€’æ•¸
        function showNotification(user) {
            const area = document.getElementById('notificationArea');
            document.getElementById('notifyUser').innerText = user;
            area.style.display = 'block';
            
            // æ¨¡æ“¬å€’æ•¸æ¢ (è¦–è¦ºæ•ˆæœ)
            const fill = document.getElementById('timerFill');
            fill.style.width = '100%';
            setTimeout(() => fill.style.width = '0%', 100);
        }

        // å€™è£œè€…å›è¦†ï¼šç¢ºèª
        function confirmWaitlist() {
            if (!pendingUser) return;
            currentBooking = { user: pendingUser, status: 'confirmed' };
            addLog(`[ç¢ºèª] å€™è£œè€… ${pendingUser} æ¥å—é ç´„ã€‚æµç¨‹çµæŸã€‚`);
            
            closeNotification();
            updateUI();
        }

        // å€™è£œè€…å›è¦†ï¼šæ”¾æ£„
        function rejectWaitlist() {
            if (!pendingUser) return;
            addLog(`[æ”¾æ£„] å€™è£œè€… ${pendingUser} æ”¾æ£„æ©Ÿæœƒã€‚`);
            pendingUser = null;
            
            closeNotification();
            updateUI(); // å…ˆæ›´æ–° UI
            setTimeout(checkWaitlist, 1000); // 1ç§’å¾Œé€šçŸ¥ä¸‹ä¸€ä½
        }

        function closeNotification() {
            document.getElementById('notificationArea').style.display = 'none';
            pendingUser = null;
        }

        // æ›´æ–°ç•«é¢ç‹€æ…‹
        function updateUI() {
            const statusBadge = document.getElementById('slotStatus');
            const ownerSpan = document.getElementById('currentOwner');
            const cancelBtn = document.getElementById('cancelBtn');

            if (currentBooking) {
                statusBadge.innerText = "å·²é¡æ»¿";
                statusBadge.className = "badge bg-red";
                ownerSpan.innerText = currentBooking.user;
                cancelBtn.disabled = false;
            } else if (pendingUser) {
                statusBadge.innerText = "ç³»çµ±é–å®šä¸­ (ç­‰å¾…å€™è£œå›è¦†)";
                statusBadge.className = "badge bg-orange";
                ownerSpan.innerText = "N/A";
                cancelBtn.disabled = true;
            } else {
                statusBadge.innerText = "å¯é ç´„";
                statusBadge.className = "badge bg-green";
                ownerSpan.innerText = "ç„¡";
                cancelBtn.disabled = true;
            }

            // æ›´æ–°å€™è£œæ¸…å–®
            const queueDiv = document.getElementById('waitlistQueue');
            if (waitlist.length === 0) {
                queueDiv.innerHTML = '<p style="color:#999; text-align:center; margin:0;">ç›®å‰ç„¡äººå€™è£œ</p>';
            } else {
                let html = '';
                waitlist.forEach((u, index) => {
                    html += `<div class="queue-item">
                        <span><strong>#${index + 1}</strong> ${u}</span>
                        <span style="font-size:0.8em; color:gray;">${new Date().toLocaleTimeString()} ç”³è«‹</span>
                    </div>`;
                });
                queueDiv.innerHTML = html;
            }
        }

        // Log è¼”åŠ©åŠŸèƒ½
        function addLog(msg) {
            const logDiv = document.getElementById('logs');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div>[${time}] ${msg}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
    </script>
</body>
</html>